<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחולל הצעות מחיר לקרוזים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1400px;
        }
        .preview-container {
            font-family: 'Assistant', sans-serif;
        }
        .preview-container * {
            pointer-events: none;
        }
        /* New styles for PDF splitting */
        .pdf-section {
            break-after: page;
        }
        .no-split {
            break-inside: avoid;
        }
        .no-break-after {
            break-after: avoid;
        }
        @media print {
            .no-print {
                display: none;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        #previewItineraryImage, #previewShipImage {
            height: 300px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800">מחולל הצעות מחיר לקרוזים</h1>
            <p class="text-gray-600 mt-2">מלא את הפרטים בטופס כדי ליצור הצעת מחיר מקצועית בפורמט PDF.</p>
        </header>
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Input Form -->
            <div id="inputForm" class="lg:w-1/2 bg-white p-6 rounded-2xl shadow-lg no-print">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">פרטי ההצעה</h2>
               
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700">שם הלקוח/ה</label>
                        <input type="text" id="clientName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="offerDate" class="block text-sm font-medium text-gray-700">תאריך ההצעה</label>
                        <input type="date" id="offerDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="cruiseLine" class="block text-sm font-medium text-gray-700">חברת שייט</label>
                        <select id="cruiseLine" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option>MSC</option>
                            <option>Royal Caribbean</option>
                            <option>Norwegian Cruise Line</option>
                            <option>CELEBRITY</option>
                            <option>COSTA</option>
                        </select>
                    </div>
                    <div>
                        <label for="shipName" class="block text-sm font-medium text-gray-700">שם האונייה</label>
                        <select id="shipName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="cruiseDuration" class="block text-sm font-medium text-gray-700">משך ההפלגה (לילות)</label>
                        <input type="number" id="cruiseDuration" value="7" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">תאריכי הפלגה</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="cruiseStartDate" class="block text-sm font-medium text-gray-700">מתאריך</label>
                                <input type="date" id="cruiseStartDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="cruiseEndDate" class="block text-sm font-medium text-gray-700">עד תאריך</label>
                                <input type="date" id="cruiseEndDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="advisor" class="block text-sm font-medium text-gray-700">יועץ שייט</label>
                        <select id="advisor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="lior">ליאור דובינובסקי</option>
                            <option value="tatiana">טטיאנה לאונוב</option>
                            <option value="koren">קורן אבסעיד</option>
                            <option value="yarden">ירדן שקד</option>
                            <option value="nir">ניר</option>
                        </select>
                    </div>
                </div>
                <!-- Itinerary Image Paste Area -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700">תמונת מסלול</label>
                    <div id="itineraryPasteTarget" contenteditable="true" tabindex="0" class="mt-1 flex justify-center items-center w-full h-24 border-2 border-dashed border-gray-300 rounded-md cursor-pointer text-gray-500 p-2 text-center transition-colors">
                        <span>הדבק תמונה כאן (Ctrl+V)</span>
                    </div>
                </div>
                <!-- Rooms Section -->
                <div id="roomsContainer" class="mt-6">
                    <h3 class="text-xl font-bold mb-3">חדרים</h3>
                </div>
                <button id="addRoomBtn" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800">+ הוסף חדר</button>
                <!-- Inclusions -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-3">מה כלול</h3>
                    <div class="space-y-2">
                        <div class="flex items-start">
                            <input id="includeTips" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-1">
                            <label for="includeTips" class="ml-2 block text-sm text-gray-900">כולל תשלום טיפים מראש</label>
                        </div>
                        <div class="flex items-start">
                            <input id="includeMeals" type="checkbox" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-1">
                            <label for="includeMeals" class="ml-2 block text-sm text-gray-900">כולל 3 ארוחות מלאות ביום + מיסים + בופה עשיר</label>
                        </div>
                        <div class="flex items-start">
                            <input id="hideTotal" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-1">
                            <label for="hideTotal" class="ml-2 block text-sm text-gray-900">הסתר סה"כ עלות</label>
                        </div>
                        <div class="flex items-start">
                            <input id="hideCruise" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded mt-1">
                            <label for="hideCruise" class="ml-2 block text-sm text-gray-900">הסתר פרטי שייט</label>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="customInclusions" class="block text-sm font-medium text-gray-700">הערות ודגשים נוספים (כל שורה תופיע כסעיף נפרד)</label>
                        <textarea id="customInclusions" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <!-- Flights Section -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-3">טיסות (אופציונלי)</h3>
                    <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                        <div id="flightsContainer" class="space-y-4">
                        </div>
                        <button id="addFlightBtn" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800">+ הוסף טיסה</button>
                        <div>
                            <label for="flightIncludes" class="block text-sm font-medium text-gray-700">הכרטיס כולל (ניתן לערוך)</label>
                            <textarea id="flightIncludes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">מזוודה 20 ק"ג
טרולי 7 ק"ג</textarea>
                        </div>
                        <div>
                            <label for="flightFreeText" class="block text-sm font-medium text-gray-700">מלל חופשי לטיסות</label>
                            <textarea id="flightFreeText" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div>
                            <label for="flightCost" class="block text-sm font-medium text-gray-700">עלות כרטיס טיסה לאדם ($)</label>
                            <input type="number" id="flightCost" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">תנאי ביטול/שינוי</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="flightNoCancel" name="flightCancelType" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="flightNoCancel" class="ml-2">ללא אפשרות ביטול / שינוי</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="flightCancellable" name="flightCancelType" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="flightCancellable" class="ml-2">ניתן לביטול / שינוי</label>
                                </div>
                                <div id="flightCancelDetails" class="hidden space-y-2 ml-6">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="flightCancelCheck" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                        <label for="flightCancelCheck" class="ml-2">ביטול</label>
                                        <input type="text" id="flightCancelFee" placeholder="דמי ביטול לנוסע" class="ml-2 w-32 border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="flightChangeCheck" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                        <label for="flightChangeCheck" class="ml-2">שינוי</label>
                                        <input type="text" id="flightChangeFee" placeholder="דמי שינוי לנוסע" class="ml-2 w-32 border-gray-300 rounded-md shadow-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Hotel Section -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-3">מלונות (אופציונלי)</h3>
                    <div id="hotelsContainer" class="space-y-4">
                        <!-- Hotels will be dynamically added here -->
                    </div>
                    <button id="addHotelBtn" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800">+ הוסף מלון</button>
                </div>
                <!-- Transfers Section -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-3">העברות (אופציונלי)</h3>
                    <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
                        <div id="transfersContainer" class="space-y-4">
                        </div>
                        <button id="addTransferBtn" class="mt-2 text-sm font-semibold text-blue-600 hover:text-blue-800">+ הוסף העברה</button>
                        <div>
                            <label for="transfersCost" class="block text-sm font-medium text-gray-700">עלות כל ההעברות ($)</label>
                            <input type="number" id="transfersCost" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">תנאי ביטול</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="transfersNoCancel" name="transfersCancelType" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="transfersNoCancel" class="ml-2">ללא אפשרות ביטול / שינוי</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="transfersCancellable" name="transfersCancelType" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <label for="transfersCancellable" class="ml-2">ניתן לביטול</label>
                                </div>
                                <div id="transfersCancelDetails" class="hidden space-y-2 ml-6">
                                    <div>
                                        <label for="transfersCancelDate" class="block text-sm font-medium text-gray-700">עד תאריך</label>
                                        <input type="date" id="transfersCancelDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    <div>
                                        <label for="transfersCancelFee" class="block text-sm font-medium text-gray-700">דמי ביטול</label>
                                        <input type="text" id="transfersCancelFee" placeholder="לדוגמה: $50" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-center">
                    <button id="generatePDFBtn" class="w-full lg:w-auto bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        הורד PDF
                    </button>
                </div>
            </div>
            <!-- Live Preview -->
            <div class="lg:w-1/2">
                <div id="preview" class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-[794px] mx-auto preview-container">
                    <!-- Header -->
                    <header class="flex justify-between items-center border-b-2 pb-4 border-gray-200">
                        <div class="text-right">
                             <img src="https://i.postimg.cc/8T2V9VQ8/2-300-X1200.png" alt="באלי קרוז" class="h-16" />
                        </div>
                        <div style="font-size: 40px; color: #3f3c66;">⚓</div>
                    </header>
                    <!-- Offer Details -->
                    <main id="preview-main" class="mt-8">
                        <p class="mb-4 text-left"><span id="previewDate" class="font-semibold"></span></p>
                        <p class="text-xl mb-6">לכבוד <span id="previewClientName" class="font-bold"></span>,</p>
                        <p class="mb-6">בהמשך לבקשתך, מצורפת הצעת מחיר להפלגת החלומות שלכם:</p>
                        <div id="previewCruiseDetails" class="bg-blue-50 rounded-lg p-4 mb-6 no-split hidden">
                            <h2 class="text-2xl font-bold mb-4 text-blue-800">פרטי ההפלגה</h2>
                            <div class="grid grid-cols-2 gap-4 text-md">
                                <p><strong>חברת שייט:</strong> <span id="previewCruiseLine"></span></p>
                                <p><strong>אונייה:</strong> <span id="previewShipName"></span></p>
                                <p><strong>משך הפלגה:</strong> <span id="previewCruiseDuration"></span> לילות</p>
                                <p><strong>תאריכים:</strong> <span id="previewCruiseDate"></span></p>
                            </div>
                        </div>
                        <!-- Itinerary Image -->
                        <div id="previewItinerarySection" class="my-6 no-split hidden">
                            <h3 class="text-xl font-bold mb-3 no-break-after">מסלול ההפלגה:</h3>
                            <img id="previewItineraryImage" src="https://placehold.co/800x300/e2e8f0/adb5bd?text=תמונת+המסלול" class="w-full rounded-lg shadow-md" alt="Itinerary Map">
                        </div>
                        <!-- Rooms Details -->
                        <div id="previewRoomsSection" class="my-6 hidden">
                            <h3 class="text-xl font-bold mb-3 no-break-after">פרטי החדרים:</h3>
                            <div id="previewRoomsContainer" class="space-y-4">
                            </div>
                            <div id="previewGuaranteeNote" class="mt-4 text-sm bg-yellow-100 p-3 rounded-lg hidden no-split">
                                חדר מסוג "גרנטי" הוא חדר שבו חברת השייט מתחייבת לסוג החדר שבחרתם, אך מיקום החדר (קומה או מיקום ספציפי באונייה) אינו מובטח. מכיוון שמיקום החדר אינו ידוע מראש, לא ניתן לדעת אם הנוף מהחדר יהיה נוף מלא, חלקי או מוסתר.<br>💡 חשוב לדעת!<br>חדרים מסוג "גרנטי" לעיתים קרובות עשויים להיות משודרגים במקרים של אוברבוקינג, כך שיש סיכוי לקבל שדרוג לסוג חדר טוב יותר 😊
                            </div>
                        </div>
                        <!-- Inclusions & Terms -->
                        <div class="mt-8 text-sm space-y-3 no-split">
                            <ul id="previewInclusions" class="list-disc list-inside bg-gray-50 p-4 rounded-lg">
                            </ul>
                        </div>
                        <!-- Flights Details -->
                        <div id="previewFlightsContainer" class="my-6 hidden">
                            <h3 class="text-xl font-bold mb-3 no-break-after">פרטי טיסות:</h3>
                            <div class="border p-3 rounded-lg bg-white space-y-2 no-split">
                                <div id="previewFlightsList" class="space-y-2"></div>
                                <ul id="previewFlightIncludes" class="list-disc list-inside"></ul>
                                <p id="previewFlightFreeText"></p>
                                <p class="font-semibold text-right" id="previewFlightCost"></p>
                                <div id="previewFlightConditions" class="text-sm"></div>
                            </div>
                        </div>
                        <!-- Hotel Details -->
                        <div id="previewHotelsSection" class="my-6 hidden">
                            <h3 class="text-xl font-bold mb-3 no-break-after">פרטי מלונות:</h3>
                            <div id="previewHotelsContainer" class="space-y-4">
                                <!-- Hotel previews go here -->
                            </div>
                        </div>
                        <!-- Transfers Details -->
                        <div id="previewTransfersContainer" class="my-6 hidden">
                            <h3 class="text-xl font-bold mb-3 no-break-after">פרטי העברות:</h3>
                            <div class="border p-3 rounded-lg bg-white space-y-2 no-split">
                                <div id="previewTransfersList" class="space-y-2"></div>
                                <p class="font-semibold text-right" id="previewTransfersCost"></p>
                                <div id="previewTransfersConditions" class="text-sm"></div>
                            </div>
                        </div>
                        <div id="previewTotalContainer" class="mt-6 text-2xl font-bold text-right text-blue-900 bg-gray-100 p-4 rounded-lg no-split">
                            סה"כ עלות: $<span id="previewTotalPrice">0</span>
                        </div>
                        <!-- Ship Image -->
                        <div id="previewShipImageSection" class="my-8 no-split hidden">
                           <img id="previewShipImage" src="https://placehold.co/800x300/e2e8f0/adb5bd?text=תמונת+האונייה" class="w-full rounded-lg shadow-md" alt="Cruise Ship">
                        </div>
                        <!-- Terms -->
                        <div class="mt-8 text-sm space-y-3">
                            <div class="border-t pt-4 mt-4 no-split">
                                <h4 class="font-bold no-break-after">תנאי תשלום וביטול:</h4>
                                <p><strong>אפשרויות תשלום:</strong></p>
                                <ul class="list-disc list-inside">
                                    <li>כרטיס אשראי עד 3 תשלומים ללא ריבית – עד 6 תשלומים עם ריבית 3% - מעל 6 ועד 18 בקרדיט.</li>
                                    <li>העברה בנקאית שקל/דולר/יורו</li>
                                    <li>מזומן לפי חוק המזומן במשרדנו</li>
                                </ul>
                                <p><strong>תנאי ביטול:</strong> בהתאם לתנאי חברת השייט המצורפים בנפרד.</p>
                                <p class="text-xs text-gray-500 mt-2">לתשומת לבך: חוק הגנת הצרכן אינו תקף להזמנות שירותי תיירות המתחילים ומסתיימים מחוץ לישראל.</p>
                                <p class="text-xs text-gray-500 mt-2">טל"ח</p>
                                <p class="text-xs text-gray-500 mt-2">*רכישת כל מוצר וביטולו אינה כפופה לשום מוצר אחר!</p>
                                <p class="font-bold mt-4">חשוב לי לציין שכל המחירים נכונים להרגע ויכולים להשתנות בכל רגע נתון.</p>
                            </div>
                        </div>
                    </main>
                    <!-- Footer -->
                    <footer class="text-center mt-12 border-t-2 pt-6 border-gray-200">
                        <p class="font-bold text-lg text-blue-800">תודה שבחרתם להפליג איתנו!</p>
                        <p id="previewAdvisor">ליאור דובינובסקי | יועץ שייט | 03-3106454 | lior@balicruise.co.il</p>
                    </footer>
                </div>
            </div>
        </div>
    </div>
    <!-- Room HTML Template (for cloning) -->
    <template id="roomTemplate">
        <div class="room-entry border p-4 rounded-lg mt-2 bg-gray-50 relative">
            <button class="remove-room-btn absolute top-2 left-2 text-red-500 hover:text-red-700 font-bold no-print">X</button>
            <div class="space-y-4">
                <!-- Composition -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">הרכב</label>
                    <select name="composition" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">בחר הרכב</option>
                        <option value="נוסע יחיד">נוסע יחיד</option>
                        <option value="זוג">זוג</option>
                        <option value="זוג + 1">זוג + 1</option>
                        <option value="זוג + 2">זוג + 2</option>
                        <option value="זוג + 3">זוג + 3</option>
                        <option value="מבוגר + ילד">מבוגר + ילד</option>
                        <option value="מבוגר + 2 ילדים">מבוגר + 2 ילדים</option>
                        <option value="מבוגר + 3 ילדים">מבוגר + 3 ילדים</option>
                        <option value="מבוגר + 4 ילדים">מבוגר + 4 ילדים</option>
                        <option value="3 מבוגרים">3 מבוגרים</option>
                        <option value="3 מבוגרים + 1">3 מבוגרים + 1</option>
                        <option value="3 מבוגרים + 2">3 מבוגרים + 2</option>
                        <option value="4 מבוגרים">4 מבוגרים</option>
                        <option value="4 מבוגרים + 1">4 מבוגרים + 1</option>
                        <option value="5 מבוגרים">5 מבוגרים</option>
                    </select>
                </div>
                <!-- Room Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">תיאור חדר</label>
                    <select name="roomType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">בחר סוג חדר</option>
                        <option value="פנימי גרנטי">פנימי גרנטי</option>
                        <option value="פנימי עם בחירת מיקום">פנימי עם בחירת מיקום</option>
                        <option value="חלון גרנטי">חלון גרנטי</option>
                        <option value="חלון עם בחירת מיקום">חלון עם בחירת מיקום</option>
                        <option value="מרפסת לים גרנטי">מרפסת לים גרנטי</option>
                        <option value="מרפסת לפנים האונייה גרנטי">מרפסת לפנים האונייה גרנטי</option>
                        <option value="מרפסת לים עם בחירת מיקום">מרפסת לים עם בחירת מיקום</option>
                        <option value="מרפסת לפנים האונייה עם בחירת מיקום">מרפסת לפנים האונייה עם בחירת מיקום</option>
                        <option value="סוויטה">סוויטה</option>
                    </select>
                </div>
                <!-- Additional Room Details (Floor and Room Number) -->
                <div class="room-details hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">קומה</label>
                        <input type="text" name="floor" placeholder="לדוגמה: 10" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">מספר חדר</label>
                        <input type="text" name="roomNumber" placeholder="לדוגמה: 1234" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <!-- Additional Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">תיאור נוסף (לא חובה)</label>
                    <textarea name="extraDesc" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="הוסף פרטים נוספים על החדר..."></textarea>
                </div>
                <!-- Price -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">עלות ($)</label>
                    <input type="number" name="roomCost" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
        </div>
    </template>
    <!-- Flight HTML Template (for cloning) -->
    <template id="flightTemplate">
        <div class="flight-entry border p-4 rounded-lg bg-gray-50 relative">
            <button class="remove-flight-btn absolute top-2 left-2 text-red-500 hover:text-red-700 font-bold no-print">X</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">חברת תעופה</label>
                    <input type="text" name="airline" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">מוצא</label>
                    <input type="text" name="from" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">יעד</label>
                    <input type="text" name="to" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">תאריך</label>
                    <input type="date" name="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">שעת המראה</label>
                    <input type="text" name="takeoff" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">שעת נחיתה</label>
                    <input type="text" name="landing" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
        </div>
    </template>
    <!-- Transfer HTML Template (for cloning) -->
    <template id="transferTemplate">
        <div class="transfer-entry border p-4 rounded-lg bg-gray-50 relative">
            <button class="remove-transfer-btn absolute top-2 left-2 text-red-500 hover:text-red-700 font-bold no-print">X</button>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">סוג העברה</label>
                    <select name="transferType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">בחר סוג</option>
                        <option value="שדה תעופה - מלון">שדה תעופה - מלון</option>
                        <option value="מלון - נמל קרוזים">מלון - נמל קרוזים</option>
                        <option value="נמל קרוזים - מלון">נמל קרוזים - מלון</option>
                        <option value="מלון - שדה תעופה">מלון - שדה תעופה</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">מלל חופשי</label>
                    <textarea name="transferFreeText" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
            </div>
        </div>
    </template>
    <!-- Hotel HTML Template (for cloning) -->
    <template id="hotelTemplate">
        <div class="hotel-entry border p-4 rounded-lg bg-gray-50 relative">
            <button class="remove-hotel-btn absolute top-2 left-2 text-red-500 hover:text-red-700 font-bold no-print">X</button>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">שם המלון</label>
                    <input type="text" name="hotelName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">מספר לילות</label>
                        <input type="number" name="hotelNights" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">מתאריך</label>
                        <input type="date" name="hotelStartDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">סוג חדר</label>
                    <textarea name="hotelRoomDesc" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">פנסיון</label>
                    <select name="hotelPension" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">בחר</option>
                        <option value="לינה בלבד">לינה בלבד</option>
                        <option value="לינה וארוחת בוקר">לינה וארוחת בוקר</option>
                        <option value="חצי פנסיון">חצי פנסיון</option>
                        <option value="פנסיון מלא">פנסיון מלא</option>
                        <option value="הכל כלול">הכל כלול</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">עלות מלון ($)</label>
                    <input type="number" name="hotelCost" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">תנאי ביטול</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" name="hotelCancellable" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2">ניתן לביטול עם דמי</label>
                        </div>
                        <div class="hotel-cancel-details hidden space-y-2 ml-6">
                            <input type="text" name="hotelCancelFee" placeholder="דמי ביטול לחדר" class="w-full border-gray-300 rounded-md shadow-sm">
                            <label class="block text-sm font-medium text-gray-700 mt-2">עד לתאריך</label>
                            <input type="date" name="hotelCancelDate" class="w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="hotelNoCancel" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2">ללא אפשרות ביטול/שינוי</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>
        // --- DATA (Simulating Excel file with images integrated) ---
        const cruiseData = {
            "MSC": [
                {name: "MSC Preziosa", year: 2013, image: "https://i.postimg.cc/vBPv6qWq/MSC16008892.jpg"},
                {name: "MSC Splendida", year: 2009, image: "https://i.postimg.cc/250WHqV3/MSC13015955.jpg"},
                {name: "MSC Magnifica", year: 2010, image: "https://i.postimg.cc/ZqbsQDxH/MSC19019079.jpg"},
                {name: "MSC Musica", year: 2006, image: "https://i.postimg.cc/5Nmwr9Kc/MSC13014701.jpg"},
                {name: "MSC Orchestra", year: 2007, image: "https://i.postimg.cc/nhPQ8XvW/MSC16006817.jpg"},
                {name: "MSC Poesia", year: 2008, image: "https://i.postimg.cc/yxRmyYrN/MSC25037328.jpg"},
                {name: "MSC Armonia", year: 2001, image: "https://i.postimg.cc/KzSpXwS4/MSC16006221-1.jpg"},
                {name: "MSC Lirica", year: 2003, image: "https://i.postimg.cc/MKSqwZJb/MSC16006932.jpg"},
                {name: "MSC Opera", year: 2004, image: "https://i.postimg.cc/VvFTm8XD/MSC15004313.jpg"},
                {name: "MSC Sinfonia", year: 2002, image: "https://i.postimg.cc/Y90j1rCm/MSC16006204.jpg"},
                {name: "MSC Divina", year: 2012, image: "https://i.postimg.cc/HkTMrCXb/MSC13011902.jpg"},
                {name: "MSC Fantasia", year: 2008, image: "https://i.postimg.cc/MTwJSthZ/MSC13012071.jpg"},
                {name: "MSC World America", year: 2025, image: "https://i.postimg.cc/MGkh7dZ0/MSC25040915.jpg"},
                {name: "MSC World Asia", year: 2026, image: "https://i.postimg.cc/C1xJkq8H/MSC25035094.jpg"},
                {name: "MSC World Europa", year: 2022, image: "https://i.postimg.cc/NM2DdwN5/MSC22013055.jpg"},
                {name: "MSC Seashore", year: 2021, image: "https://i.postimg.cc/R0HJ8VB5/MSC21007729.jpg"},
                {name: "MSC Seaside", year: 2017, image: "https://i.postimg.cc/4xrmzkh8/MSC18014069.jpg"},
                {name: "MSC Seascape", year: 2022, image: "https://i.postimg.cc/7PsswmzH/MSC21008179.jpg"},
                {name: "MSC Seaview", year: 2018, image: "https://i.postimg.cc/pdWz9tNg/MSC19018890.jpg"},
                {name: "MSC Bellissima", year: 2019, image: "https://i.postimg.cc/xjwxFgbc/MSC18013997.jpg"},
                {name: "MSC Euribia", year: 2023, image: "https://i.postimg.cc/Sswr3NRw/MSC23019432.jpg"},
                {name: "MSC Grandiosa", year: 2019, image: "https://i.postimg.cc/nr62DVqH/MSC19001443.jpg"},
                {name: "MSC Meraviglia", year: 2017, image: "https://i.postimg.cc/DzMxTcmJ/MSC17011157.jpg"},
                {name: "MSC Virtuosa", year: 2021, image: "https://i.postimg.cc/bwF5yPBw/MSC18017765.jpg"}
            ],
            "Royal Caribbean": [
                {name: "Adventure of the Seas", year: 2001, image: "https://i.postimg.cc/3wBSGMKP/1623457762-DJI-0713.jpg"},
                {name: "Allure of the Seas", year: 2010, image: "https://i.postimg.cc/pLYbs6WB/1722900416-RCI-AL-CGI-ALT-201911-MVerdure-OA19-Aerial-FLL1-027-RT-EXT-LR.jpg"},
                {name: "Anthem of the Seas", year: 2015, image: "https://i.postimg.cc/mDFGy2tP/1446674152-image002.jpg"},
                {name: "Brilliance of the Seas", year: 2002, image: "https://i.postimg.cc/1XGhbC0P/1697834102-RCI-Brilliance-Exterior-Side-4-UR.jpg"},
                {name: "Enchantment of the Seas", year: 1997, image: "https://i.postimg.cc/hPsNx7pC/image-2301.avif"},
                {name: "Explorer of the Seas", year: 2000, image: "https://i.postimg.cc/VkYb65NB/ew0-KICAi-Yn-Vja2-V0-Ijog-In-Byb2-Qtc2-Vydmlj-ZS1pd-HJhdm-Vs-Y2-Ru-LWVua-GFu-Y2-Vid-WNr-ZXQt-Y2-Y0c-TZkc-XY5dj-I4-Iiw-NCi-Ag-Imtl.jpg"},
                {name: "Freedom of the Seas", year: 2006, image: "https://i.postimg.cc/MKwnPX12/1624145764-IMG-0571.jpg"},
                {name: "Grandeur of the Seas", year: 1996, image: "https://i.postimg.cc/K8zvwTzV/harmony-of-the-seas-slide-1600x702.jpg"},
                {name: "Harmony of the Seas", year: 2016, image: "https://i.postimg.cc/nVPdqbmD/1473174759-HM-Aft.jpg"},
                {name: "Icon of the Seas", year: 2024, image: "https://i.postimg.cc/gJJ0F6Nr/1708378767-RCI-PDC-202401-CC-JGraham-Icon-Arrival-DJI-A003-0044-RT-EXT.jpg"},
                {name: "Independence of the Seas", year: 2008, image: "https://i.postimg.cc/bY0qCgzL/1600881251-RCI-ID-June2018-Portugal-Heli-Jordan-Dani-Sunrise-Ship-01-0012-RET-CMYK.jpg"},
                {name: "Jewel of the Seas", year: 2004, image: "https://i.postimg.cc/wjyPPxXH/1616633882-jewel-of-the-seas-grenada-docked-harbor-21.jpg"},
                {name: "Legend of the Seas", year: 1995, image: "https://i.postimg.cc/fTpZkr5z/2113-a15df9c337f.jpg"},
                {name: "Liberty of the Seas", year: 2007, image: ""},
                {name: "Mariner of the Seas", year: 2003, image: ""},
                {name: "Navigator of the Seas", year: 2002, image: ""},
                {name: "Oasis of the Seas", year: 2009, image: ""},
                {name: "Odyssey of the Seas", year: 2021, image: ""},
                {name: "Ovation of the Seas", year: 2016, image: ""},
                {name: "Quantum of the Seas", year: 2014, image: ""},
                {name: "Radiance of the Seas", year: 2001, image: ""},
                {name: "Rhapsody of the Seas", year: 1997, image: ""},
                {name: "Serenade of the Seas", year: 2003, image: ""},
                {name: "Spectrum of the Seas", year: 2019, image: ""},
                {name: "Star of the Seas", year: 2025, image: ""},
                {name: "Symphony of the Seas", year: 2018, image: ""},
                {name: "Utopia of the Seas", year: 2024, image: ""},
            ],
            "Norwegian Cruise Line": [
                {name: "Norwegian Aqua", year: 2025, image: "https://i.postimg.cc/YCVXc3v4/norwegianaquainmiami4.jpg"},
                {name: "Norwegian Bliss", year: 2018, image: "https://i.postimg.cc/8ctHZB8z/norwegianbliss-ketchikanalaska-bird039seyeview.jpg"},
                {name: "Norwegian Breakaway", year: 2013, image: "https://i.postimg.cc/XNQkS8hV/norwegianbreakaway-indestination-st-luciaaerial.jpg"},
                {name: "Norwegian Dawn", year: 2002, image: "https://i.postimg.cc/9QT9Mtxw/norwegiandawn-aerial.jpg"},
                {name: "Norwegian Encore", year: 2019, image: "https://i.postimg.cc/bvmwNZj2/norwegianencore-birdseyeview.jpg"},
                {name: "Norwegian Epic", year: 2010, image: "https://i.postimg.cc/XvrYqVNH/norwegianepic-aerial.jpg"},
                {name: "Norwegian Escape", year: 2015, image: "https://i.postimg.cc/LsxjK4Cx/norwegianescape-tortola-9.jpg"},
                {name: "Norwegian Getaway", year: 2014, image: "https://i.postimg.cc/mDh7dKsz/norwegianjade-aerial.jpg"},
                {name: "Norwegian Jade", year: 2006, image: "https://i.postimg.cc/mDh7dKsz/norwegianjade-aerial.jpg"},
                {name: "Norwegian Jewel", year: 2005, image: "https://i.postimg.cc/sgR8t41D/norwegianjewel-indestinationjuneaualaska.jpg"},
                {name: "Norwegian Joy", year: 2017, image: "https://i.postimg.cc/ZnmmVzk4/norwegianjoy.jpg"},
                {name: "Norwegian Luna", year: 2026, image: "https://i.postimg.cc/0NSh3X0Q/norwegianlunaoverhead.jpg"},
                {name: "Norwegian Pearl", year: 2006, image: "https://i.postimg.cc/nr3W7ypd/norwegianpearl-aerial.jpg"},
                {name: "Norwegian Prima", year: 2022, image: "https://i.postimg.cc/7h53sdSt/norwegianprima-aerial-stern.jpg"},
                {name: "Norwegian Sky", year: 1999, image: "https://i.postimg.cc/zfPSCqgH/norwegiansky-aerial.jpg"},
                {name: "Norwegian Spirit", year: 1998, image: "https://i.postimg.cc/gJZR38p1/norwegianspirit-aerial-1.jpg"},
                {name: "Norwegian Star", year: 2001, image: "https://i.postimg.cc/pX6sQYML/norwegianstar-aerial.jpg"},
                {name: "Norwegian Sun", year: 2001, image: "https://i.postimg.cc/bN7QN6jk/norwegiansun-aerial.jpg"},
                {name: "Norwegian Viva", year: 2023, image: "https://i.postimg.cc/FFfprkLt/ncl-viva-aerial-sanjuan-0910.jpg"},
                {name: "Norwegian Gem", year: 2007, image: "https://i.postimg.cc/Z5LF7r1N/norwegiangem-aerial.jpg"},
                {name: "Pride of America", year: 2005, image: "https://i.postimg.cc/SNF6mT48/prideofamerica-aerial.jpg"}
            ],
            "CELEBRITY": [
                {name: "Celebrity Apex", year: 2020, image: "https://i.postimg.cc/76hB396G/Celebrity-Apex-300x225.webp"},
                {name: "Celebrity Ascent", year: 2023, image: "https://i.postimg.cc/zvR0MfTq/Celebrity-Ascent-300x225.webp"},
                {name: "Celebrity Beyond", year: 2022, image: "https://i.postimg.cc/JzmCNwWs/Celebrity-Beyond-300x225.webp"},
                {name: "Celebrity Constellation", year: 2002, image: "https://i.postimg.cc/N0jhn1FY/Celebrity-Constellation-300x225.webp"},
                {name: "Celebrity Eclipse", year: 2010, image: "https://i.postimg.cc/TwKzdfn4/Celebrity-Eclipse-300x225.webp"},
                {name: "Celebrity Edge", year: 2018, image: "https://i.postimg.cc/1X6bFBC0/Celebrity-Edge-300x225.webp"},
                {name: "Celebrity Equinox", year: 2009, image: "https://i.postimg.cc/L6tr6yZ2/Celebrity-Equinox-300x225.webp"},
                {name: "Celebrity Flora", year: 2019, image: "https://i.postimg.cc/g2G1wvvR/Celebrity-Flora-300x225.webp"},
                {name: "Celebrity Infinity", year: 2001, image: "https://i.postimg.cc/jj59ct3S/Celebrity-Infinity-300x225.webp"},
                {name: "Celebrity Millennium", year: 2000, image: "https://i.postimg.cc/KYHWswCr/Celebrity-Millennium-300x225.webp"},
                {name: "Celebrity Reflection", year: 2012, image: "https://i.postimg.cc/C5yQwDhR/Celebrity-Reflection-300x225.webp"},
                {name: "Celebrity Silhouette", year: 2011, image: "https://i.postimg.cc/RhcbhFhX/Celebrity-Silhouette-300x225.webp"},
                {name: "Celebrity Solstice", year: 2008, image: "https://i.postimg.cc/1R6dJWBw/Celebrity-Solstice-300x225.webp"},
                {name: "Celebrity Summit", year: 2001, image: "https://i.postimg.cc/VL8VTjZT/Celebrity-Summit-300x225.webp"},
                {name: "Celebrity Xce", year: 2025, image: "https://i.postimg.cc/ZKxMhC1q/Celebrity-Xcel-300x225.webp"}
            ],
            "COSTA": [
                {name: "Costa Deliziosa", year: 2010, image: "https://i.postimg.cc/ryCJD7gn/Costa-Deliziosa-300x225.webp"},
                {name: "Costa Diadema", year: 2014, image: "https://i.postimg.cc/Fsrx3GB9/Costa-Diadema-300x225.webp"},
                {name: "Costa Fascinosa", year: 2012, image: "https://i.postimg.cc/TYtJ9mzn/Costa-Fascinosa-300x225.webp"},
                {name: "Costa Favolosa", year: 2011, image: "https://i.postimg.cc/t4ft0bCT/Costa-Favolosa-300x225.webp"},
                {name: "Costa Fortuna", year: 2003, image: "https://i.postimg.cc/Ssb6sG9b/Costa-Fortuna-300x225.webp"},
                {name: "Costa Pacifica", year: 2009, image: "https://i.postimg.cc/bNwQsrZr/Costa-Pacifica-300x225.webp"},
                {name: "Costa Serena", year: 2007, image: "https://i.postimg.cc/7Z9Pb3WJ/Costa-Serena.jpg"},
                {name: "Costa Smeralda", year: 2019, image: "https://i.postimg.cc/YCgj9Bzj/Costa-Smeralda-300x225.webp"},
                {name: "Costa Toscana", year: 2021, image: "https://i.postimg.cc/FRK90M3y/Costa-Toscana-300x225.webp"},
                {name: "Costa Firenze", year: 2021, image: "https://i.postimg.cc/sgRsTQ5D/Costa-Firenze-300x225.webp"}
            ]
        };
        // --- ADVISORS DATA ---
        const advisors = {
            "lior": "ליאור דובינובסקי / Lior Dovinovsky| יועץ שייט | 03-3106454 | lior@balicruise.co.il",
            "tatiana": "טטיאנה לאונוב/Tatyana Leonov | יועצת שייט | 03-3106454 | tatiana@balicruise.co.il",
            "koren": "קורן אבסעיד | Koren avsaid | מנהל מחלקת שייט | 03-3106454 | Koren@balicruise.co.il",
            "yarden": "ירדן שקד | Yarden shaked | יועץ שייט | 03-3106454 | Yarden@balicruise.co.il",
            "nir": "ניר | Nir | יועץ שייט | 03-3106454 | nir@balicruise.co.il"
        };
        // Guarantee message
        const guaranteeMessage = "מיקום החדר ייקבע על ידי חברת השייט";
        // Room types that require details
        const detailRoomTypes = [
            "פנימי עם בחירת מיקום",
            "חלון עם בחירת מיקום",
            "מרפסת לים עם בחירת מיקום",
            "מרפסת לפנים האונייה עם בחירת מיקום",
            "סוויטה"
        ];
       
        // --- CACHE DOM ELEMENTS ---
        const elements = {
            clientName: document.getElementById('clientName'),
            offerDate: document.getElementById('offerDate'),
            cruiseLine: document.getElementById('cruiseLine'),
            shipName: document.getElementById('shipName'),
            cruiseDuration: document.getElementById('cruiseDuration'),
            cruiseStartDate: document.getElementById('cruiseStartDate'),
            cruiseEndDate: document.getElementById('cruiseEndDate'),
            advisor: document.getElementById('advisor'),
            itineraryPasteTarget: document.getElementById('itineraryPasteTarget'),
            roomsContainer: document.getElementById('roomsContainer'),
            addRoomBtn: document.getElementById('addRoomBtn'),
            includeTips: document.getElementById('includeTips'),
            includeMeals: document.getElementById('includeMeals'),
            hideTotal: document.getElementById('hideTotal'),
            hideCruise: document.getElementById('hideCruise'),
            customInclusions: document.getElementById('customInclusions'),
            flightsContainer: document.getElementById('flightsContainer'),
            addFlightBtn: document.getElementById('addFlightBtn'),
            flightIncludes: document.getElementById('flightIncludes'),
            flightFreeText: document.getElementById('flightFreeText'),
            flightCost: document.getElementById('flightCost'),
            flightNoCancel: document.getElementById('flightNoCancel'),
            flightCancellable: document.getElementById('flightCancellable'),
            flightCancelCheck: document.getElementById('flightCancelCheck'),
            flightChangeCheck: document.getElementById('flightChangeCheck'),
            flightCancelFee: document.getElementById('flightCancelFee'),
            flightChangeFee: document.getElementById('flightChangeFee'),
            transfersContainer: document.getElementById('transfersContainer'),
            addTransferBtn: document.getElementById('addTransferBtn'),
            transfersCost: document.getElementById('transfersCost'),
            transfersNoCancel: document.getElementById('transfersNoCancel'),
            transfersCancellable: document.getElementById('transfersCancellable'),
            transfersCancelDate: document.getElementById('transfersCancelDate'),
            transfersCancelFee: document.getElementById('transfersCancelFee'),
            hotelsContainer: document.getElementById('hotelsContainer'),
            addHotelBtn: document.getElementById('addHotelBtn'),
            generatePDFBtn: document.getElementById('generatePDFBtn'),
            // Preview elements
            previewClientName: document.getElementById('previewClientName'),
            previewDate: document.getElementById('previewDate'),
            previewCruiseDetails: document.getElementById('previewCruiseDetails'),
            previewCruiseLine: document.getElementById('previewCruiseLine'),
            previewShipName: document.getElementById('previewShipName'),
            previewCruiseDuration: document.getElementById('previewCruiseDuration'),
            previewCruiseDate: document.getElementById('previewCruiseDate'),
            previewItinerarySection: document.getElementById('previewItinerarySection'),
            previewItineraryImage: document.getElementById('previewItineraryImage'),
            previewRoomsSection: document.getElementById('previewRoomsSection'),
            previewRoomsContainer: document.getElementById('previewRoomsContainer'),
            previewGuaranteeNote: document.getElementById('previewGuaranteeNote'),
            previewInclusions: document.getElementById('previewInclusions'),
            previewFlightsContainer: document.getElementById('previewFlightsContainer'),
            previewFlightsList: document.getElementById('previewFlightsList'),
            previewFlightIncludes: document.getElementById('previewFlightIncludes'),
            previewFlightFreeText: document.getElementById('previewFlightFreeText'),
            previewFlightCost: document.getElementById('previewFlightCost'),
            previewFlightConditions: document.getElementById('previewFlightConditions'),
            previewHotelsSection: document.getElementById('previewHotelsSection'),
            previewHotelsContainer: document.getElementById('previewHotelsContainer'),
            previewTransfersContainer: document.getElementById('previewTransfersContainer'),
            previewTransfersList: document.getElementById('previewTransfersList'),
            previewTransfersCost: document.getElementById('previewTransfersCost'),
            previewTransfersConditions: document.getElementById('previewTransfersConditions'),
            previewTotalContainer: document.getElementById('previewTotalContainer'),
            previewTotalPrice: document.getElementById('previewTotalPrice'),
            previewShipImageSection: document.getElementById('previewShipImageSection'),
            previewShipImage: document.getElementById('previewShipImage'),
            previewAdvisor: document.getElementById('previewAdvisor'),
            previewElement: document.getElementById('preview'),
            previewMain: document.getElementById('preview-main'),
            inputForm: document.getElementById('inputForm')
        };
       
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            populateShips();
            setupEventListeners();
            updatePreview();
        });
       
        function setupEventListeners() {
            // All form inputs
            elements.inputForm.addEventListener('input', updateStateAndPreview);
            elements.inputForm.addEventListener('change', updateStateAndPreview);
            // Dynamic buttons
            elements.addRoomBtn.addEventListener('click', () => { addRoom(); updateStateAndPreview(); });
            elements.addFlightBtn.addEventListener('click', () => { addFlight(); updateStateAndPreview(); });
            elements.addHotelBtn.addEventListener('click', () => { addHotel(); updateStateAndPreview(); });
            elements.addTransferBtn.addEventListener('click', () => { addTransfer(); updateStateAndPreview(); });
            // Specific event listeners
            elements.cruiseLine.addEventListener('change', populateShips);
            elements.itineraryPasteTarget.addEventListener('paste', handlePaste);
            elements.itineraryPasteTarget.addEventListener('click', () => elements.itineraryPasteTarget.focus());
            elements.generatePDFBtn.addEventListener('click', generatePDF);
            elements.flightCancellable.addEventListener('change', toggleFlightCancelDetails);
            elements.transfersCancellable.addEventListener('change', toggleTransfersCancelDetails);
        }
        // --- STATE MANAGEMENT (localStorage) ---
        function saveState() {
            const state = {};
            const formInputs = elements.inputForm.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                if(input.closest('.hotel-entry')) return; // Handled in dynamic fields
                if (input.type === 'checkbox' || input.type === 'radio') {
                    state[input.id] = input.checked;
                } else {
                    state[input.id] = input.value;
                }
            });
            const dynamicFields = {
                rooms: [],
                flights: [],
                transfers: [],
                hotels: []
            };
            elements.roomsContainer.querySelectorAll('.room-entry').forEach(roomDiv => {
                const roomData = {};
                roomDiv.querySelectorAll('input, select, textarea').forEach(input => {
                    roomData[input.name] = input.value;
                });
                dynamicFields.rooms.push(roomData);
            });
            elements.flightsContainer.querySelectorAll('.flight-entry').forEach(flightDiv => {
                const flightData = {};
                flightDiv.querySelectorAll('input').forEach(input => {
                    flightData[input.name] = input.value;
                });
                dynamicFields.flights.push(flightData);
            });
            elements.transfersContainer.querySelectorAll('.transfer-entry').forEach(transferDiv => {
                const transferData = {};
                transferDiv.querySelectorAll('select, textarea').forEach(input => {
                    transferData[input.name] = input.value;
                });
                dynamicFields.transfers.push(transferData);
            });
            elements.hotelsContainer.querySelectorAll('.hotel-entry').forEach(hotelDiv => {
                const hotelData = {};
                hotelDiv.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.type === 'checkbox') {
                        hotelData[input.name] = input.checked;
                    } else {
                        hotelData[input.name] = input.value;
                    }
                });
                dynamicFields.hotels.push(hotelData);
            });
            localStorage.setItem('quoteFormState', JSON.stringify({ ...state, dynamicFields }));
        }
        function loadState() {
            const savedState = JSON.parse(localStorage.getItem('quoteFormState'));
            if (!savedState) {
                elements.offerDate.valueAsDate = new Date();
                addRoom();
                addFlight();
                addHotel();
                return;
            }
            // Restore static inputs
            const formInputs = elements.inputForm.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                if(input.closest('.hotel-entry')) return;
                if (savedState[input.id] !== undefined) {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = savedState[input.id];
                    } else {
                        input.value = savedState[input.id];
                    }
                }
            });
            // Restore dynamic fields
            elements.roomsContainer.innerHTML = '';
            elements.flightsContainer.innerHTML = '';
            elements.transfersContainer.innerHTML = '';
            elements.hotelsContainer.innerHTML = '';
            savedState.dynamicFields.rooms.forEach(roomData => addRoom(roomData));
            savedState.dynamicFields.flights.forEach(flightData => addFlight(flightData));
            savedState.dynamicFields.transfers.forEach(transferData => addTransfer(transferData));
             if (savedState.dynamicFields.hotels) {
                savedState.dynamicFields.hotels.forEach(hotelData => addHotel(hotelData));
            }
        }
        function updateStateAndPreview() {
            saveState();
            updatePreview();
        }
        // --- DYNAMIC FORM LOGIC ---
        function populateShips() {
            const cruiseLine = elements.cruiseLine.value;
            const shipSelect = elements.shipName;
            shipSelect.innerHTML = '';
            const ships = cruiseData[cruiseLine] || [];
            ships.forEach(ship => {
                const option = document.createElement('option');
                option.value = ship.name;
                option.textContent = `${ship.name} (${ship.year})`;
                shipSelect.appendChild(option);
            });
            updateStateAndPreview();
        }
       
        function addRoom(initialData = {}) {
            const template = document.getElementById('roomTemplate');
            const clone = template.content.cloneNode(true);
            const roomDiv = clone.querySelector('.room-entry');
            elements.roomsContainer.appendChild(clone);
           
            // Set initial data and setup listeners
            if (Object.keys(initialData).length > 0) {
                 for (const key in initialData) {
                    const input = roomDiv.querySelector(`[name="${key}"]`);
                    if (input) input.value = initialData[key];
                }
            }
           
            roomDiv.querySelector('.remove-room-btn').addEventListener('click', () => {
                roomDiv.remove();
                updateStateAndPreview();
            });
            roomDiv.querySelector('select[name="roomType"]').addEventListener('change', () => toggleRoomDetails(roomDiv));
            toggleRoomDetails(roomDiv); // Initial toggle
        }
        function addFlight(initialData = {}) {
            const template = document.getElementById('flightTemplate');
            const clone = template.content.cloneNode(true);
            const flightDiv = clone.querySelector('.flight-entry');
            elements.flightsContainer.appendChild(clone);
           
            if (Object.keys(initialData).length > 0) {
                for (const key in initialData) {
                    const input = flightDiv.querySelector(`[name="${key}"]`);
                    if (input) input.value = initialData[key];
                }
            }
            // Default airline from previous flight if exists
            const existingFlights = elements.flightsContainer.querySelectorAll('.flight-entry');
            if (existingFlights.length > 1 && !initialData.airline) { // Since we just added one
                const previousAirline = existingFlights[existingFlights.length - 2].querySelector('input[name="airline"]').value;
                if (previousAirline) {
                    flightDiv.querySelector('input[name="airline"]').value = previousAirline;
                }
            }
            flightDiv.querySelector('.remove-flight-btn').addEventListener('click', () => {
                flightDiv.remove();
                updateStateAndPreview();
            });
        }
       
        function addTransfer(initialData = {}) {
            const template = document.getElementById('transferTemplate');
            const clone = template.content.cloneNode(true);
            const transferDiv = clone.querySelector('.transfer-entry');
            elements.transfersContainer.appendChild(clone);
            if (Object.keys(initialData).length > 0) {
                for (const key in initialData) {
                    const input = transferDiv.querySelector(`[name="${key}"]`);
                    if (input) input.value = initialData[key];
                }
            }
            transferDiv.querySelector('.remove-transfer-btn').addEventListener('click', () => {
                transferDiv.remove();
                updateStateAndPreview();
            });
        }
        function addHotel(initialData = {}) {
            const template = document.getElementById('hotelTemplate');
            const clone = template.content.cloneNode(true);
            const hotelDiv = clone.querySelector('.hotel-entry');
            elements.hotelsContainer.appendChild(clone);
            if (Object.keys(initialData).length > 0) {
                for (const key in initialData) {
                    const input = hotelDiv.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = initialData[key];
                        } else {
                            input.value = initialData[key];
                        }
                    }
                }
            }
            const cancellableCheckbox = hotelDiv.querySelector('[name="hotelCancellable"]');
            const cancelDetailsDiv = hotelDiv.querySelector('.hotel-cancel-details');
            const toggleDetails = () => {
                cancelDetailsDiv.classList.toggle('hidden', !cancellableCheckbox.checked);
            };
            cancellableCheckbox.addEventListener('change', toggleDetails);
           
            hotelDiv.querySelector('.remove-hotel-btn').addEventListener('click', () => {
                hotelDiv.remove();
                updateStateAndPreview();
            });
           
            toggleDetails(); // Initial check
        }
       
        function toggleTransfersCancelDetails() {
            const detailsDiv = document.getElementById('transfersCancelDetails');
            const isCancellable = elements.transfersCancellable.checked;
            detailsDiv.classList.toggle('hidden', !isCancellable);
        }
       
        function toggleFlightCancelDetails() {
            const detailsDiv = document.getElementById('flightCancelDetails');
            const isCancellable = elements.flightCancellable.checked;
            detailsDiv.classList.toggle('hidden', !isCancellable);
        }
       
        function toggleRoomDetails(roomEntry) {
            const detailsDiv = roomEntry.querySelector('.room-details');
            const roomType = roomEntry.querySelector('select[name="roomType"]').value;
            const isDetailed = detailRoomTypes.includes(roomType);
            detailsDiv.classList.toggle('hidden', !isDetailed);
        }
       
        // --- IMAGE PASTE LOGIC (only for itinerary) ---
        function handlePaste(event) {
            event.preventDefault();
            const items = (event.clipboardData || window.clipboardData).items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    const blob = item.getAsFile();
                    if (blob) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            elements.previewItineraryImage.src = e.target.result;
                            elements.itineraryPasteTarget.innerHTML = `<span class="text-green-600 font-semibold">תמונה הועלתה בהצלחה!</span>`;
                            elements.itineraryPasteTarget.classList.remove('border-gray-300');
                            elements.itineraryPasteTarget.classList.add('border-green-500');
                            saveState(); // Save image state
                        };
                        reader.readAsDataURL(blob);
                    }
                    return;
                }
            }
        }
        // --- PREVIEW UPDATE LOGIC ---
        function updatePreview() {
            // Simple text fields
            elements.previewClientName.textContent = elements.clientName.value || '___';
            const offerDate = elements.offerDate.value;
            elements.previewDate.textContent = offerDate ? `תאריך: ${new Date(offerDate).toLocaleDateString('he-IL')}` : '';
            elements.previewCruiseLine.textContent = elements.cruiseLine.value;
            elements.previewShipName.textContent = elements.shipName.value;
            elements.previewCruiseDuration.textContent = elements.cruiseDuration.value || '7';
            const cruiseStart = elements.cruiseStartDate.value ? new Date(elements.cruiseStartDate.value).toLocaleDateString('he-IL') : '';
            const cruiseEnd = elements.cruiseEndDate.value ? new Date(elements.cruiseEndDate.value).toLocaleDateString('he-IL') : '';
            elements.previewCruiseDate.textContent = cruiseStart && cruiseEnd ? `${cruiseStart} - ${cruiseEnd}` : '___';
       
            // Advisor
            const selectedAdvisor = elements.advisor.value;
            elements.previewAdvisor.textContent = advisors[selectedAdvisor];
       
            // Show cruise sections only if cruise line is selected and not hidden
            const hasCruiseLine = !!elements.cruiseLine.value;
            const hideCruiseSection = elements.hideCruise.checked;
            elements.previewCruiseDetails.classList.toggle('hidden', hideCruiseSection || !hasCruiseLine);
            elements.previewItinerarySection.classList.toggle('hidden', hideCruiseSection || !hasCruiseLine);
            elements.previewRoomsSection.classList.toggle('hidden', hideCruiseSection || !hasCruiseLine);
            elements.previewShipImageSection.classList.toggle('hidden', hideCruiseSection || !hasCruiseLine);
       
            // Ship Image
            const cruiseLine = elements.cruiseLine.value;
            const shipName = elements.shipName.value;
            const ship = cruiseData[cruiseLine]?.find(s => s.name === shipName);
            if (ship && ship.image) {
                elements.previewShipImage.src = ship.image;
            } else {
                elements.previewShipImage.src = 'https://placehold.co/800x300/e2e8f0/adb5bd?text=תמונת+האונייה';
            }
       
            // Rooms and Total Price
            elements.previewRoomsContainer.innerHTML = '';
            let totalPrice = 0;
            let totalPassengers = 0;
            let hasGuarantee = false;
       
            const roomEntries = elements.roomsContainer.querySelectorAll('.room-entry');
            roomEntries.forEach((room, index) => {
                const composition = room.querySelector('select[name="composition"]').value;
                switch(composition) {
                    case 'נוסע יחיד': totalPassengers += 1; break;
                    case 'זוג': totalPassengers += 2; break;
                    case 'זוג + 1': totalPassengers += 3; break;
                    case 'זוג + 2': totalPassengers += 4; break;
                    case 'זוג + 3': totalPassengers += 5; break;
                    case 'מבוגר + ילד': totalPassengers += 2; break;
                    case 'מבוגר + 2 ילדים': totalPassengers += 3; break;
                    case 'מבוגר + 3 ילדים': totalPassengers += 4; break;
                    case 'מבוגר + 4 ילדים': totalPassengers += 5; break;
                    case '3 מבוגרים': totalPassengers += 3; break;
                    case '3 מבוגרים + 1': totalPassengers += 4; break;
                    case '3 מבוגרים + 2': totalPassengers += 5; break;
                    case '4 מבוגרים': totalPassengers += 4; break;
                    case '4 מבוגרים + 1': totalPassengers += 5; break;
                    case '5 מבוגרים': totalPassengers += 5; break;
                }
                const roomType = room.querySelector('select[name="roomType"]').value;
                const floor = room.querySelector('input[name="floor"]').value;
                const roomNumber = room.querySelector('input[name="roomNumber"]').value;
                const extraDesc = room.querySelector('textarea[name="extraDesc"]').value;
                const costValue = parseFloat(room.querySelector('input[name="roomCost"]').value) || 0;
       
                if (roomType && roomType.includes('גרנטי')) {
                    hasGuarantee = true;
                }
       
                if (composition || roomType || extraDesc || costValue > 0) {
                    let roomDetails = [];
                    if (composition) roomDetails.push(`<strong>הרכב:</strong> ${composition}`);
                    if (roomType) {
                        let typeText = `<strong>תיאור:</strong> ${roomType}`;
                        if (roomType.includes('גרנטי')) {
                            typeText += ` - ${guaranteeMessage}`;
                        } else if (floor || roomNumber) {
                            const locationDetails = [];
                            if (floor) locationDetails.push(`קומה: ${floor}`);
                            if (roomNumber) locationDetails.push(`חדר: ${roomNumber}`);
                            if (locationDetails.length > 0) {
                                typeText += ` (${locationDetails.join(', ')})`;
                            }
                        }
                        roomDetails.push(typeText);
                    }
                    if (extraDesc) roomDetails.push(`${extraDesc}`);
       
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'border p-3 rounded-lg bg-white no-split';
                    roomDiv.innerHTML = `
                        <p><strong>חדר ${index + 1}:</strong></p>
                        <p class="space-y-1 my-2">${roomDetails.join(' | ')}</p>
                        <p class="font-semibold text-right">עלות: $${costValue.toLocaleString()}</p>
                    `;
                    elements.previewRoomsContainer.appendChild(roomDiv);
                    totalPrice += costValue;
                }
            });
            elements.previewGuaranteeNote.classList.toggle('hidden', !hasGuarantee);
       
            // Inclusions
            const inclusionsList = elements.previewInclusions;
            inclusionsList.innerHTML = '';
            let hasInclusions = false;
           
            if (elements.includeMeals.checked) {
                addInclusionItem(inclusionsList, 'כולל 3 ארוחות מלאות ביום, מיסים ובופה עשיר לאורך היום.');
                hasInclusions = true;
            }
            addInclusionItem(inclusionsList, elements.includeTips.checked ? 'כולל תשלום טיפים מראש.' : 'לא כולל תשלום טיפים מראש.');
            hasInclusions = true;
            const customInclusionsText = elements.customInclusions.value.trim();
            if (customInclusionsText) {
                customInclusionsText.split('\n').filter(line => line.trim()).forEach(line => {
                    addInclusionItem(inclusionsList, line.trim());
                    hasInclusions = true;
                });
            }
            if (!hasInclusions) {
                addInclusionItem(inclusionsList, 'אין הכללות מיוחדות.');
            }
            // Flights
            const flightCostPerPerson = parseFloat(elements.flightCost.value) || 0;
            const flightCostValue = flightCostPerPerson * totalPassengers;
            const hasFlights = elements.flightsContainer.querySelectorAll('.flight-entry').length > 0 || flightCostValue > 0;
            elements.previewFlightsContainer.classList.toggle('hidden', !hasFlights);
            if (hasFlights) {
                elements.previewFlightsList.innerHTML = '';
                elements.flightsContainer.querySelectorAll('.flight-entry').forEach((flight, index) => {
                    const airline = flight.querySelector('input[name="airline"]').value || '___';
                    const from = flight.querySelector('input[name="from"]').value || '___';
                    const to = flight.querySelector('input[name="to"]').value || '___';
                    const date = flight.querySelector('input[name="date"]').value ? new Date(flight.querySelector('input[name="date"]').value).toLocaleDateString('he-IL') : '___';
                    const takeoff = flight.querySelector('input[name="takeoff"]').value || '___';
                    const landing = flight.querySelector('input[name="landing"]').value || '___';
                    const p = document.createElement('p');
                    p.textContent = `טיסה בחברת ${airline} מ ${from} ל ${to} בתאריך ${date} המראה ${takeoff} נחיתה ${landing}`;
                    elements.previewFlightsList.appendChild(p);
                });
                const includesList = elements.previewFlightIncludes;
                includesList.innerHTML = '';
                elements.flightIncludes.value.split('\n').forEach(line => {
                    if (line.trim()) {
                        addInclusionItem(includesList, line.trim());
                    }
                });
                elements.previewFlightFreeText.textContent = elements.flightFreeText.value;
               
                if (flightCostPerPerson > 0 && totalPassengers > 0) {
                    elements.previewFlightCost.textContent = `עלות: $${flightCostPerPerson.toLocaleString()} לאדם X ${totalPassengers} נוסעים = $${flightCostValue.toLocaleString()}`;
                } else if (flightCostPerPerson > 0) {
                    elements.previewFlightCost.textContent = `עלות: $${flightCostPerPerson.toLocaleString()} לאדם`;
                } else {
                    elements.previewFlightCost.textContent = '';
                }
                totalPrice += flightCostValue;
       
                let conditionsText = '';
                if (elements.flightNoCancel.checked) {
                    conditionsText = '<p>ללא אפשרות ביטול / שינוי מרגע אישור ההזמנה</p>';
                } else if (elements.flightCancellable.checked) {
                    const cancelFee = elements.flightCancelFee.value;
                    const changeFee = elements.flightChangeFee.value;
                    if (elements.flightCancelCheck.checked && cancelFee) {
                        conditionsText += `<p>ביטול – ניתן לביטול עד 72 שעות לפני ההמראה ב ${cancelFee} לנוסע</p>`;
                    }
                    if (elements.flightChangeCheck.checked && changeFee) {
                        conditionsText += `<p>שינוי – ניתן לשינוי עד 72 שעות לפני ההמראה ב ${changeFee} לנוסע ומותנה באותה מחלקת שירות, במידה ואין משלמים הפרשי מחירים.</p>`;
                    }
                }
                elements.previewFlightConditions.innerHTML = conditionsText;
            }
       
            // Hotels
            elements.previewHotelsContainer.innerHTML = '';
            let totalHotelCost = 0;
            const hotelEntries = elements.hotelsContainer.querySelectorAll('.hotel-entry');
            const hasHotels = hotelEntries.length > 0 && Array.from(hotelEntries).some(h => h.querySelector('[name="hotelName"]').value || h.querySelector('[name="hotelCost"]').value > 0);
           
            elements.previewHotelsSection.classList.toggle('hidden', !hasHotels);
            if (hasHotels) {
                hotelEntries.forEach((hotel) => {
                    const hotelName = hotel.querySelector('[name="hotelName"]').value || '___';
                    const hotelCostValue = parseFloat(hotel.querySelector('[name="hotelCost"]').value) || 0;
                   
                    if (!hotelName && !hotelCostValue) return;
                    const hotelNights = hotel.querySelector('[name="hotelNights"]').value || '___';
                    const hotelStartDateValue = hotel.querySelector('[name="hotelStartDate"]').value;
                    const hotelStartDate = hotelStartDateValue ? new Date(hotelStartDateValue).toLocaleDateString('he-IL') : '___';
                    const hotelRoomDesc = hotel.querySelector('[name="hotelRoomDesc"]').value || '___';
                    const hotelPension = hotel.querySelector('[name="hotelPension"]').value || '___';
                   
                    totalHotelCost += hotelCostValue;
                    let conditionsText = '';
                    const hotelNoCancel = hotel.querySelector('[name="hotelNoCancel"]').checked;
                    const hotelCancellable = hotel.querySelector('[name="hotelCancellable"]').checked;
                   
                    if (hotelNoCancel) {
                        conditionsText += '<p>ללא אפשרות ביטול/ שינוי מרגע אישור ההזמנה</p>';
                    } else if (hotelCancellable) {
                        const cancelFee = hotel.querySelector('[name="hotelCancelFee"]').value;
                        const cancelDateValue = hotel.querySelector('[name="hotelCancelDate"]').value;
                        const cancelDate = cancelDateValue ? new Date(cancelDateValue).toLocaleDateString('he-IL') : '___';
                       
                        if (cancelFee && cancelDate !== '___') {
                            conditionsText += `<p>ביטול – ניתן לבטל בעלות של ${cancelFee} לחדר עד לתאריך ${cancelDate} ולאחריו דמי ביטול מלאים</p>`;
                        }
                    }
                   
                    const hotelPreviewDiv = document.createElement('div');
                    hotelPreviewDiv.className = 'border p-3 rounded-lg bg-white space-y-2 no-split';
                    hotelPreviewDiv.innerHTML = `
                        <h4 class="font-bold text-md">${hotelName}</h4>
                        <p>${hotelNights} לילות מתאריך ${hotelStartDate}</p>
                        <p>סוג חדר: ${hotelRoomDesc}</p>
                        <p>פנסיון: ${hotelPension}</p>
                        <p class="font-semibold text-right">עלות: $${hotelCostValue.toLocaleString()}</p>
                        <div class="text-sm">${conditionsText}</div>
                    `;
                    elements.previewHotelsContainer.appendChild(hotelPreviewDiv);
                });
            }
           
            totalPrice += totalHotelCost;
            // Transfers
            const transfersCostValue = parseFloat(elements.transfersCost.value) || 0;
            const hasTransfers = elements.transfersContainer.querySelectorAll('.transfer-entry').length > 0 || transfersCostValue > 0;
            elements.previewTransfersContainer.classList.toggle('hidden', !hasTransfers);
            if (hasTransfers) {
                elements.previewTransfersList.innerHTML = '';
                elements.transfersContainer.querySelectorAll('.transfer-entry').forEach((transfer, index) => {
                    const type = transfer.querySelector('select[name="transferType"]').value || '___';
                    const freeText = transfer.querySelector('textarea[name="transferFreeText"]').value || '';
                    if (type !== '___' || freeText) {
                        const p = document.createElement('p');
                        p.textContent = `${index + 1}. ${type}${freeText ? ` - ${freeText}` : ''}`;
                        elements.previewTransfersList.appendChild(p);
                    }
                });
                elements.previewTransfersCost.textContent = `עלות: $${transfersCostValue.toLocaleString()}`;
                totalPrice += transfersCostValue;
       
                let conditionsText = '';
                if (elements.transfersNoCancel.checked) {
                    conditionsText += `<p>ללא אפשרות ביטול / שינוי</p>`;
                } else if (elements.transfersCancellable.checked && elements.transfersCancelDate.value && elements.transfersCancelFee.value) {
                    const transfersCancelDateFormatted = new Date(elements.transfersCancelDate.value).toLocaleDateString('he-IL');
                    conditionsText += `<p>ניתן לביטול עד לתאריך ${transfersCancelDateFormatted} בדמי ביטול בסך ${elements.transfersCancelFee.value}</p>`;
                }
                elements.previewTransfersConditions.innerHTML = conditionsText;
            }
       
            // Total
            elements.previewTotalContainer.classList.toggle('hidden', elements.hideTotal.checked);
            elements.previewTotalPrice.textContent = totalPrice.toLocaleString();
           
            // Toggle conditional fields
            toggleFlightCancelDetails();
            toggleTransfersCancelDetails();
        }
       
        function addInclusionItem(list, text) {
            const li = document.createElement('li');
            li.textContent = text;
            list.appendChild(li);
        }
        // --- PDF GENERATION ---
        async function generatePDF() {
            elements.previewElement.classList.remove('shadow-lg');
            const { jsPDF } = window.jspdf;
       
            // Clone the preview element to a temporary container for rendering
            const previewClone = elements.previewElement.cloneNode(true);
            previewClone.style.position = 'absolute';
            previewClone.style.left = '-9999px';
            previewClone.style.width = '794px'; // A4 width in px for rendering
            document.body.appendChild(previewClone);
       
            // Remove any dynamic buttons that shouldn't be in the PDF
            previewClone.querySelectorAll('.remove-room-btn, .remove-flight-btn, .remove-transfer-btn, .remove-hotel-btn').forEach(btn => btn.remove());
       
            // Ensure all images are loaded before rendering to canvas
            const images = previewClone.querySelectorAll('img');
            const promises = Array.from(images).map(img => new Promise(resolve => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = resolve; // Handle errors gracefully
                }
            }));
            await Promise.all(promises);
       
            const canvas = await html2canvas(previewClone, {
                scale: 2,
                useCORS: true,
                letterRendering: true
            });
       
            // Remove the clone after rendering
            previewClone.remove();
       
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgHeight = canvas.height * pdfWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
       
            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;
       
            while (heightLeft > 0) {
                position -= pdfHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }
       
            const clientName = elements.clientName.value || 'הצעה';
            const shipName = elements.shipName.value || 'קרוז';
            pdf.save(`הצעת מחיר ${shipName} - ${clientName}.pdf`);
            elements.previewElement.classList.add('shadow-lg');
        }
    </script>
    <footer class="text-center mt-8 text-xs text-gray-500">
        פותח על ידי ליאור דובינובסקי
    </footer>
</body>
</html>
